---
interface Props {
  title: string;
  description: string;
  lang: string;
  alternateUrl?: string;
}

const { title, description, lang, alternateUrl } = Astro.props;
const alternateLang = lang === 'en' ? 'es' : 'en';
---

<!DOCTYPE html>
<html lang={lang} data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title}</title>
  <meta name="description" content={description}>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <!-- SEO -->
  <link rel="canonical" href={Astro.url.href}>
  {alternateUrl && <link rel="alternate" hreflang={alternateLang} href={alternateUrl} />}
  <link rel="alternate" hreflang={lang} href={Astro.url.href} />
  <link rel="alternate" hreflang="x-default" href={Astro.url.href.replace(`/${lang}/`, '/es/')} />

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'}>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800;900&family=Figtree:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ProfessionalService",
    "name": "clicroot",
    "description": description,
    "url": Astro.url.href,
    "serviceType": "SEO Consulting",
    "areaServed": ["US", "CO", "MX", "ES"],
    "availableLanguage": ["English", "Spanish"]
  })} />
</head>
<body>
  <slot />

  <script>
    // Dark mode
    const html = document.documentElement;
    const stored = localStorage.getItem('theme');
    if (stored) html.setAttribute('data-theme', stored);
    else if (window.matchMedia('(prefers-color-scheme: dark)').matches) html.setAttribute('data-theme', 'dark');

    document.getElementById('themeToggle')?.addEventListener('click', () => {
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });

    // Scroll reveal
    const obs = new IntersectionObserver(entries => {
      entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
    }, { threshold: 0.1, rootMargin: '0px 0px -20px 0px' });
    document.querySelectorAll('.reveal').forEach(el => obs.observe(el));

    // Counter animation
    const cobs = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const c = e.target as HTMLElement;
          const target = parseInt(c.dataset.target || '0');
          const start = performance.now();
          function update(now: number) {
            const p = Math.min((now - start) / 2000, 1);
            c.textContent = Math.floor((1 - Math.pow(1 - p, 3)) * target).toString();
            if (p < 1) requestAnimationFrame(update);
            else c.textContent = target.toString();
          }
          requestAnimationFrame(update);
          cobs.unobserve(c);
        }
      });
    }, { threshold: 0.5 });
    document.querySelectorAll('.counter').forEach(c => cobs.observe(c));

    // Smooth scroll
    document.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const href = (e.currentTarget as HTMLAnchorElement).getAttribute('href');
        if (href) {
          const t = document.querySelector(href);
          if (t) t.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

    // Nav scroll
    const nav = document.getElementById('nav');
    window.addEventListener('scroll', () => nav?.classList.toggle('scrolled', window.scrollY > 40));

    // Mobile menu
    document.getElementById('hamburger')?.addEventListener('click', () => {
      document.getElementById('mobileMenu')?.classList.add('open');
      document.body.style.overflow = 'hidden';
    });
    (window as any).closeMobile = () => {
      document.getElementById('mobileMenu')?.classList.remove('open');
      document.body.style.overflow = '';
    };
    document.getElementById('mobileClose')?.addEventListener('click', (window as any).closeMobile);

    // Form
    document.getElementById('contactForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      const btn = document.getElementById('formSubmit') as HTMLButtonElement;
      btn.textContent = 'âœ“';
      btn.style.background = 'var(--accent)';
      btn.style.color = 'white';
      setTimeout(() => { btn.textContent = btn.dataset.label || 'Send'; btn.style.background = ''; btn.style.color = ''; (e.target as HTMLFormElement).reset(); }, 3000);
    });
  </script>
</body>
</html>

<style is:global>
  @import '../styles/global.css';
</style>
